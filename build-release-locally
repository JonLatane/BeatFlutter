#!/usr/bin/env sh

# Paths assume pwd is directory of build script.
cd "$(dirname "$0")"

# yes | rm -rf ~/Development/flutter/flutter/bin/cache/* && \
echo "# Changing to channel beta for iOS/Android/web builds..." && \
flutter channel beta && flutter upgrade && \
echo "" && \
echo "#-----------------------------------------------------------------------" && \
echo "# Building/Archiving for iOS" && \
echo "#-----------------------------------------------------------------------" && \
flutter build ios | sed 's/.*/\[iOS\] &/' && \
echo "Archiving iOS app..." && \
xcodebuild -workspace ios/Runner.xcworkspace -scheme Runner -configuration release archive | sed 's/.*/\[iOS\] &/' && \
echo "iOS app built! Manually archive/upload build to TestFlight in XCode." && \
open "ios/Runner.xcworkspace" && \
echo "" && \
echo "#-----------------------------------------------------------------------" && \
echo "# Building for Android" && \
echo "#-----------------------------------------------------------------------" && \
flutter build appbundle | sed 's/.*/\[Android\] &/' && \
echo "Manually upload appbundle to Google Play!" && \
open "build/app/outputs/bundle/release/" && \
open 'https://play.google.com/console/developers/8301034569696927852/app/4974878702686446069/tracks/internal-testing' && \
echo "" && \
echo "#-----------------------------------------------------------------------" && \
echo "# Building for Web and copying to ../beatscratch-page/app-staging" && \
echo "#-----------------------------------------------------------------------" && \
flutter build web --dart-define=FLUTTER_WEB_USE_SKIA=true --release | sed 's/.*/\[Web\] &/' && \
cp -r build/web/* ../beatscratch-page/app-staging && \

# yes | rm -rf ~/Development/flutter/flutter/bin/cache/*
echo "# Changing to channel dev for macOS build..."
flutter channel dev && flutter upgrade && \
echo "" && \
echo "#-----------------------------------------------------------------------" && \
echo "# Building for macOS and archiving app" && \
echo "#-----------------------------------------------------------------------" && \
flutter build macos | sed 's/.*/\[macOS\] &/' && \
cd build/macos/Build/Products/Release && \
tar -cavf BeatFlutter.tar.bz2 BeatScratch.app && open . && cd - && \
echo "macOS app built! Manually upload to Dropbox" && \
open "https://www.dropbox.com/home" && \
echo "Web app built to app-staging! Manually copy to prod app and/or deploy to beatscratch.io" && \
echo "Build complete! Have fun uploading and awaiting Apple's blessings..."
